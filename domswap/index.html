<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <title>DOM SWAP</title>
    <style>
      body {
        text-align: center;
      }
      div {
        display: inline-block;
        padding-left: 3em;
        padding-right: 3em;
        padding-bottom: 3em;
        border: 0.2em solid black;
        border-radius: 2em;
        margin-top: 20%;
      }
    </style>
  </head>
  <body>
    <script type="module">
      import {
        Lucid,
        Blockfrost,
        utf8ToHex,
        toUnit,
        Data,
        Constr,
        fromHex,
        toHex,
        sha256,
      } from "https://unpkg.com/lucid-cardano@0.7.0/web/mod.js";
      const lucid = await Lucid.new(
        new Blockfrost(
          "https://cardano-preview.blockfrost.io/api/v0",
          "previewCuKgDj1hQgDyMMcsbLKSt8GOKXDIGbv2"
        ),
        "Preview"
      );
      import * as cbor from "https://deno.land/x/cbor@v1.4.1/index.js";

      import data from "./plutus.json" assert { type: "json" };
      console.log(data);

      const hyperSpaceScript = {
        type: "PlutusV2",
        script: toHex(cbor.encode(fromHex(data.validators[0].compiledCode))),
      };

      var policyidScript = {
        type: "PlutusV2",
        script: toHex(cbor.encode(fromHex(data.validators[2].compiledCode))),
      };

      var policyId = lucid.utils.mintingPolicyToId(policyidScript);
      console.log("policy NFT");
      console.log(policyId);

      const validatorHash = lucid.utils.validatorToScriptHash(hyperSpaceScript);
      console.log("validator hash");
      console.log(validatorHash);
      const CredentialSC = lucid.utils.scriptHashToCredential(validatorHash);
      const addressRequest = lucid.utils.credentialToAddress(CredentialSC);
      console.log("address of request");
      console.log(addressRequest);
      let api = undefined;

      var wallet = "nami";

      function checkAccess() {
        return connected;
      }
      async function connect() {
        api = await window.cardano[wallet].enable();
        document.getElementById("swap").disabled = false;
        document.getElementById("connect").disabled = true;
      }

      async function swap() {
        api = await window.cardano[wallet].enable();

        lucid.selectWallet(api);
        window.owner = await lucid.wallet.address();
        const { paymentCredential, stakeCredential } =
          lucid.utils.getAddressDetails(await lucid.wallet.address());
        console.log("credentials");
        console.log(paymentCredential.hash);
        console.log(stakeCredential.hash);
        var assetName = "7374617274696e674e4654";

        var unitNFT = policyId + assetName; //new nft policyid made from minter aiken and enceded name matching old asset

        var oldNFT =
          "83c421f63be2811a4c65ddf1ce1059111dfc8de5fc35635979b2e4e3" +
          assetName; //policyId + asset name (hex encoded)

        var redeemerRequest = Data.to(new Constr(0, [assetName]));

        var datumRequest = Data.to(new Constr(0, []));

        var nfts = {};
        nfts[oldNFT] = 1n;

        const tx = await lucid
          .newTx()
          .payToContract(addressRequest, { inline: datumRequest }, nfts)
          .mintAssets({ [unitNFT]: 1n }, redeemerRequest)
          .attachMintingPolicy(policyidScript)
          .complete();

        const signedTx = await tx.sign().complete();
        const txHash = await signedTx.submit();
        console.log(txHash);
      }

      document.getElementById("swap").disabled = true;
      document.getElementById("connect").disabled = false;
      document.getElementById("connect").onclick = async () => {
        await connect();
      };
      document.getElementById("swap").onclick = async () => {
        await swap();
      };
    </script>

    <div>
      <h1>World Domination</h1>
      <button id="connect">connect</button>
      <button id="swap">swap</button>
    </div>
  </body>
</html>
