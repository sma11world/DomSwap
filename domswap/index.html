<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <title>DOM SWAP</title>
    <style>
      body {
        text-align: center;
      }
      div {
        display: inline-block;
        padding-left: 3em;
        padding-right: 3em;
        padding-bottom: 3em;
        border: 0.2em solid black;
        border-radius: 2em;
        margin-top: 20%;
      }
    </style>
  </head>
  <body>
    <script type="module">
      import {
        Lucid,
        Blockfrost,
        utf8ToHex,
        toUnit,
        Data,
        Constr,
        fromHex,
        toHex,
      applyParamsToScript,
        sha256,
      } from "https://unpkg.com/lucid-cardano@0.7.0/web/mod.js";
     
      const lucid = await Lucid.new(
        new Blockfrost(
          "https://cardano-preprod.blockfrost.io/api/v0",
          "preprodwMpZm1FWCvyw5XtRi8MwGNlntKG4AeXJ"
        ),
        "Preprod"
      );
      import * as cbor from "https://deno.land/x/cbor@v1.4.1/index.js";

      import data from "./plutus.json" assert { type: "json" };
      console.log(data);

      

      let api = undefined;
      var wallet = "nami";

      function checkAccess() {
        return connected;
      }

      async function connect() {
        api = await window.cardano[wallet].enable();
        document.getElementById("swap").disabled = false;
        document.getElementById("connect").disabled = true;
        let x = document.getElementById("burns");
          x.style.display = "block";
      }

      async function burn() {
        const hyperSpaceScript = {
        type: "PlutusV2",
        script: toHex(cbor.encode(fromHex(data.validators[0].compiledCode))),
      };

      // var policyidScript = {
      //   type: "PlutusV2",
      //   script: toHex(cbor.encode(fromHex(data.validators[2].compiledCode))),
      // };

      var policyidScript = {
      type: "PlutusV2",
      script: applyParamsToScript(
              toHex(cbor.encode(fromHex(data.validators[2].compiledCode))),
              "de383a04ea577b55882ea3084aab822adcba607b2467d09314f1817d",
          )
      };

      var policyId = lucid.utils.mintingPolicyToId(policyidScript);
      console.log("new policy NFT");
      console.log(policyId);

      const validatorHash = lucid.utils.validatorToScriptHash(hyperSpaceScript);
      console.log("validator hash");
      console.log(validatorHash);

      const CredentialSC = lucid.utils.scriptHashToCredential(validatorHash);
      const addressRequest = lucid.utils.credentialToAddress(CredentialSC);

      console.log("address of request");
      console.log(addressRequest);
      ///BURN
        api = await window.cardano[wallet].enable();

        lucid.selectWallet(api);
        window.owner = await lucid.wallet.address();
        const { paymentCredential, stakeCredential } =
          lucid.utils.getAddressDetails(await lucid.wallet.address());

        console.log("credentials");
        console.log(paymentCredential.hash);
        console.log(stakeCredential.hash);

        var assetName = document.getElementById("assetName");// "000de140646f6d7a30";
        console.log("assetName");
        console.log(assetName);
        var unitNFT = "de383a04ea577b55882ea3084aab822adcba607b2467d09314f1817d" + assetName; //new nft policyid made from minter aiken and enceded name matching old asset

        console.log("new");
        console.log(unitNFT);

        var assetToBurn =
          policyId +
          assetName; //policyId + asset name (hex encoded)

        console.log("old");
        console.log(assetToBurn);

        var redeemerRequest = Data.to(new Constr(0, [assetName]));

        var datumRequest = Data.to(new Constr(0, []));

        var nfts = {};
        nfts[assetToBurn] = -1n;

        const tx = await lucid
          .newTx()
          .payToContract(addressRequest, { inline: datumRequest }, nfts)
          .mintAssets({ [unitNFT]: 1n }, redeemerRequest)
          .attachMintingPolicy(policyidScript)
          .complete();

        const signedTx = await tx.sign().complete();
        const txHash = await signedTx.submit();
        console.log(txHash);
      }

      async function swap() {
        const hyperSpaceScript = {
        type: "PlutusV2",
        script: toHex(cbor.encode(fromHex(data.validators[0].compiledCode))),
      };

      var policyidScript = {
        type: "PlutusV2",
        script: toHex(cbor.encode(fromHex(data.validators[2].compiledCode))),
      };

      var policyId = lucid.utils.mintingPolicyToId(policyidScript);
      console.log("new policy NFT");
      console.log(policyId);

      const validatorHash = lucid.utils.validatorToScriptHash(hyperSpaceScript);
      console.log("validator hash");
      console.log(validatorHash);

      const CredentialSC = lucid.utils.scriptHashToCredential(validatorHash);
      const addressRequest = lucid.utils.credentialToAddress(CredentialSC);

      console.log("address of request");
      console.log(addressRequest);
      //SWAP 
        api = await window.cardano[wallet].enable();

        lucid.selectWallet(api);
        window.owner = await lucid.wallet.address();
        const { paymentCredential, stakeCredential } =
          lucid.utils.getAddressDetails(await lucid.wallet.address());

        console.log("credentials");
        console.log(paymentCredential.hash);
        console.log(stakeCredential.hash);

        var assetName = document.getElementById("assetName").value;// "000de140646f6d7a30";
        console.log("assetName");
        console.log(assetName);
        var unitNFT = policyId + assetName; //new nft policyid made from minter aiken and enceded name matching old asset

        console.log("new");
        console.log(unitNFT);

        var oldNFT =
          "de383a04ea577b55882ea3084aab822adcba607b2467d09314f1817d" +
          assetName; //policyId + asset name (hex encoded)

        console.log("old");
        console.log(oldNFT);

        var redeemerRequest = Data.to(new Constr(0, [assetName]));

        var datumRequest = Data.to(new Constr(0, []));

        var nfts = {};
        nfts[oldNFT] = 1n;

        const tx = await lucid
          .newTx()
          .payToContract(addressRequest, { inline: datumRequest }, nfts)
          .mintAssets({ [unitNFT]: 1n }, redeemerRequest)
          .attachMintingPolicy(policyidScript)
          .complete();

        const signedTx = await tx.sign().complete();
        const txHash = await signedTx.submit();
        console.log(txHash);
      }

      
      document.getElementById("swap").disabled = true;
      let x = document.getElementById("burns");
      x.style.display = "none";
      document.getElementById("connect").disabled = false;

      document.getElementById("connect").onclick = async () => {
        await connect();
      };

      document.getElementById("swap").onclick = async () => {
        await swap();
      };

      document.getElementById("burn").onclick = async () => {
        await burn();
      };
    </script>

    <div>
      <h1>World Domination</h1>
      <input type="text" id="assetName" placeholder="000de140646f6d7a30">
      <button id="connect">connect</button>
      <button id="swap">swap</button>
    <br>
    <br>
      <div id="burns" style="border: none !important;">
        <h1>burn asset</h1>
        <button id="burn">burn</button>
    </div>
  </body>
</html>
